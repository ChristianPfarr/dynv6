# /etc/cron.hourly/dynv6

# test various files
test -f /etc/default/dynv6 && . /etc/default/dynv6
test -f /etc/dynv6/config && . /etc/dynv6/config

# check if dynv6 is enabled
if [ "$ENABLED" = "0" ] ; then
    exit 0
fi

# set timestamp
TIMESTAMP=$(date +"%H:%M:%S - %d.%m.%Y")

# test if log-folder exist, if not create it
if ! [ -d $LOGDIR ] ; then
        mkdir -p $LOGDIR
fi

# test if tmp-folder exist, if not create it
if ! [ -d $TMPDIR ] ; then
        mkdir -p $TMPDIR
fi

[ -e $ADDR6FILE ] && OLD=`cat $ADDR6FILE`

if [ -z "$HOSTNAME" -o -z "$TOKEN" ]; then
  echo "$TIMESTAMP: cant find token or hostname" >> $LOG
  exit 1
fi

address=$(ip -6 addr list scope global $device | grep -v " fd" | sed -n 's/.*inet6 \([0-9a-f:]\+\).*/\1/p' | head -n 1)

if [ -e /usr/bin/curl ]; then
  bin="curl -fsS"
elif [ -e /usr/bin/wget ]; then
  bin="wget -O-"
else
  echo "$ts: neither curl nor wget found" >> $log
  exit 1
fi

if [ -z "$address" ]; then
  echo "$ts: no IPv6 address found" >> $log
  exit 1
fi

# address with netmask
CURRENT=$address/$NETMASK

if [ "$OLD" = "$current" ]; then
  echo "$ts: IPv6 address unchanged" >> $log
  exit
fi

# send addresses to dynv6
$bin "http://dynv6.com/api/update?hostname=$HOSTNAME&ipv6=$CURRENT&token=$TOKEN"
$bin "http://ipv4.dynv6.com/api/update?hostname=$HOSTNAME&ipv4=auto&token=$TOKEN"

# save current address
echo $CURRENT > $FILE
echo "$TIMESTAMP: update successful: $CURRENT" >> $LOG
